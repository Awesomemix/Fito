<!Doctype html>
<html>
<head>
<meta charset="UTF-8">
<script src="../js/web3.min.js"></script>
<script src="../../build/contracts/FitoContract.js"></script>
<script type="text/javascript">

    console.log('starting...');
    //connect web3 and check if web3 is connected correctly
    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
    } else {
        // set the provider you want from Web3.providers
        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
    }

    if (web3.isConnected()) {
        console.log("connected");
    } else {
        console.log("not connected")
    }

    // In case : Static Frontend, on webserver ----------------------
    // Use "../js/web3.FitoContracts.js" when Dynamic Frontend on npm/nodejs
    // <script src="../js/web3.FitoContract.js">
    // ----------------------------------------------------------------    
    // function loadJSON() {   
    //     var xobj = new XMLHttpRequest();
    //     xobj.overrideMimeType("application/json");
    //     xobj.open('GET', '../../build/contracts/FitoContract.json', false);
    //     xobj.send(null);
    //     var rtn = xobj;
    //     var rtn = JSON.parse(rtn.responseText);
    //     return rtn;
    // }
    // var jsonFile = loadJSON();
    // var contractAbi = jsonFile.abi;
    // var contractAddress = jsonFile.networks[ Object.keys(jsonFile.networks)[0] ].address;
    // var FitoContract = web3.eth.contract(contractAbi).at(contractAddress);
    // -----------------------------------------------------------------
    
    // In case : Static Frontend, local ganache without webserver
    // Need to create and load "../../build/contracts/FitoContract.js"
    // ----------------------------------------------------------------    
    var contractAbi = FitoContract_build.abi;
    var contractAddress = FitoContract_build.networks[ Object.keys(FitoContract_build.networks)[0] ].address;
    var FitoContract = web3.eth.contract(contractAbi).at(contractAddress);
    // -----------------------------------------------------------------

    // Default account 설정
    // 추후 지갑과 연동
    web3.eth.defaultAccount = web3.eth.accounts[0];
    
    function initShares() {
        try {
            console.log("to web3.eth.accounts[9]", web3.eth.accounts[9]);
            console.log(typeof(web3.eth.accounts[9]));
            var rtn = FitoContract.initShares(web3.eth.accounts[9])
            document.getElementById("initShares").innerText = 'web3.eth.accounts[0] :' + rtn;
        } catch (err) {
            document.getElementById("initShares").innerText = err;
        }
    }

    function addTradingData() {
        try {
            console.log("buyer web3.eth.accounts[0]", web3.eth.accounts[0]);
            console.log("seller web3.eth.accounts[9]", web3.eth.accounts[9]);

            var idx = FitoContract.addTradingData(web3.eth.accounts[9], 100, {value: web3.toWei(7, "ether"), from:web3.eth.accounts[0], to:web3.eth.accounts[9], gas:300000});
            document.getElementById("addTradingData").innerText = idx;
        } catch (err) {
            document.getElementById("addTradingData").innerText = err;
        }
    }

    function getOwnedShares() {
        try {
            console.log("buyer web3.eth.accounts[9]", web3.eth.accounts[9]);
            console.log("seller web3.eth.accounts[1]", web3.eth.accounts[0]);
            var stock9 = FitoContract.getOwnedShares(web3.eth.accounts[9]);
            var stock0 = FitoContract.getOwnedShares(web3.eth.accounts[0]);
            document.getElementById("getOwnedShares").innerText = "9 :" + stock9 + " / " + "0 :" + stock0;
        } catch (err) {
            document.getElementById("getOwnedShares").innerText = err;
        }
    }


</script>

</head>

<body>
    <h1>KISA Corp.</h1>
    <p>
        <span id="getTotalNumberOfIssues">Loading...</span>
    </p>
    <p><button type="button" onClick="initShares();">initShares :</button><div id="initShares"></div></p><br />
    <p><button type="button" onClick="addTradingData();">addTradingData :</button><div id="addTradingData"></div></p><br />
    <p><button type="button" onClick="getOwnedShares();">getOwnedShares :</button><div id="getOwnedShares"></div></p><br />
    <p><div id="contractAbi"></div></p>
    <p>--------------------------------------</p>
    <p><div id="contractAbi2"></div></p>
</body>
</html>